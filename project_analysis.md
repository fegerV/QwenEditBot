# Подробный анализ проекта QwenEditBot

## Общее описание

QwenEditBot - это Telegram-бот для редактирования изображений с использованием интеграции с ComfyUI. Проект состоит из трех основных компонентов: бэкенд (FastAPI), Telegram-бот (aiogram) и воркер (обработчик задач). Система позволяет пользователям выбирать предустановленные стили или создавать собственные промпты для обработки изображений.

## Архитектура проекта

### 1. Backend (FastAPI)
- REST API для управления пользователями, заданиями, балансами и платежами
- Интеграция с базой данных (SQLAlchemy) и Redis
- Обработка задач через очередь Redis
- Веб-интерфейс API документации (Swagger/OpenAPI)

### 2. Telegram Bot (aiogram 3.x)
- Интерактивный чат-бот с FSM (Finite State Machine) для управления состоянием
- Поддержка различных пресетов обработки изображений
- Управление балансом пользователей
- Платежные функции (временно отключены для тестирования)

### 3. Worker (Обработчик задач)
- Отдельный сервис для обработки задач изображений
- Интеграция с ComfyUI для генерации изображений
- Блокировка GPU для предотвращения конфликта ресурсов
- Система повторных попыток обработки задач
- Мониторинг файлов (опционально)

## База данных (SQLAlchemy)

### Модели:
- **User**: информация о пользователях Telegram, баланс
- **Preset**: предустановленные стили обработки (категории: стили, портреты, продукты, освещение, анимация, улучшение)
- **Job**: задания на обработку изображений (очередь, обработка, завершено, ошибка)
- **Payment**: данные о платежах (интеграция с ЮKassa)
- **PaymentLog**: журнал платежей

## Интеграция с ComfyUI

- HTTP API клиент для взаимодействия с ComfyUI
- Отправка рабочих процессов (workflows) на обработку
- Мониторинг статуса выполнения заданий
- Загрузка результатов обработки

## Система баланса и оплаты

### Баланс:
- Каждый пользователь имеет начальный баланс (по умолчанию 60 баллов)
- Обработка изображений стоит 30 баллов (настраивается)
- Администраторы и пользователи с неограниченным доступом не тратят баллы
- Возможность возврата баллов при ошибках обработки

### Платежи:
- Интеграция с ЮKassa для пополнения баланса
- Поддержка разных методов оплаты (карта, СБП)
- История платежей для каждого пользователя
- Система ограничения частоты запросов

## Система очередей задач (Redis)

- Использование Redis для хранения очереди задач
- Асинхронная обработка заданий
- Блокировка GPU для предотвращения одновременной обработки
- Система повторных попыток для неудачных заданий

## Рабочий процесс обработки изображений

1. Пользователь выбирает пресет или вводит собственный промпт
2. Пользователь загружает изображение в Telegram-бот
3. Бот создает задание и добавляет его в очередь Redis
4. Воркер извлекает задание из очереди
5. Воркер получает блокировку GPU
6. Воркер отправляет изображение и промпт в ComfyUI
7. Воркер ожидает завершения обработки
8. Воркер сохраняет результат и уведомляет пользователя
9. Состояние задания обновляется в базе данных

## Конфигурация

### Настройки (settings):
- URL ComfyUI для обработки изображений
- Параметры базы данных и Redis
- Настройки оплаты и баланса
- Параметры безопасности и ограничения частоты

### Административные функции:
- Автоматическое начисление еженедельного бонуса
- Возможность пополнения баланса администратором
- Отслеживание ошибок и логирование

## Безопасность

- Проверка типов файлов при загрузке
- Защита от обхода системы баланса
- Ограничение доступа к файлам сервера
- Валидация входных данных

## Особенности реализации

- Миграции базы данных с помощью Alembic
- Автоматическая генерация пресетов при первом запуске
- Поддержка нескольких методов оплаты
- Гибкая система пресетов с возможностью расширения
- Обработка ошибок и повторные попытки
- Система логирования всех операций

## Тестирование и отладка

- Режим тестирования с отключенной системой баланса
- Подробное логирование всех операций
- Возможность отключения платежной системы
- Механизмы отладки и мониторинга

## Заключение

QwenEditBot представляет собой хорошо архитектурированное приложение с четким разделением ответственности между компонентами. Система обеспечивает масштабируемую обработку изображений с использованием современных технологий и предоставляет удобный интерфейс для пользователей через Telegram-бота.