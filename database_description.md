# Описание базы данных

## Общая информация

База данных проекта представляет собой систему хранения информации для Telegram-бота, который предоставляет услуги генерации и редактирования изображений с использованием AI. В системе реализованы функции управления пользователями, балансом, пресетами обработки изображений, заданиями обработки и платежами.

## Структура таблиц

### 1. Таблица `users`

Хранит информацию о пользователях Telegram-бота.

#### Поля:

- `user_id` (Integer, Primary Key, Index) — уникальный идентификатор пользователя в системе. Автоматически генерируется при создании записи.
- `telegram_id` (Integer, Unique, Index) — уникальный идентификатор пользователя в Telegram. Используется для связи с реальным пользователем.
- `username` (String(100), Index) — имя пользователя в Telegram (если доступно).
- `balance` (Float, default=60.0) — баланс пользователя в условных единицах (по умолчанию 60). Используется для оплаты услуг.
- `created_at` (DateTime(timezone=True), server_default=func.now()) — дата и время создания учетной записи пользователя.

#### Назначение:
- Хранение основной информации о пользователях системы
- Учет баланса для оплаты услуг
- Связь с внешними системами через telegram_id
- Отслеживание времени регистрации

### 2. Таблица `presets`

Хранит предустановленные шаблоны для обработки изображений.

#### Поля:

- `id` (Integer, Primary Key, Index) — уникальный идентификатор пресета.
- `category` (String(50), Index) — категория пресета (например, "фото", "иллюстрация", "стилизация").
- `name` (String(100), Index) — название пресета.
- `prompt` (Text) — текстовое описание или инструкция для генерации/обработки изображения.
- `icon` (String(255)) — путь к иконке пресета.
- `price` (Float, default=30.0) — стоимость использования пресета.
- `order_index` (Integer, default=0, Index) — порядковый номер для сортировки пресетов.
- `workflow_type` (String(50), default="qwen_edit_2511") — тип рабочего процесса, используемого для обработки.

#### Назначение:
- Хранение готовых конфигураций для обработки изображений
- Управление ценами на различные виды обработки
- Категоризация пресетов для удобства выбора
- Определение порядка отображения пресетов
- Поддержка различных типов рабочих процессов

### 3. Таблица `jobs`

Хранит информацию о заданиях на обработку изображений.

#### Поля:

- `id` (Integer, Primary Key, Index) — уникальный идентификатор задания.
- `user_id` (Integer, ForeignKey("users.user_id")) — ссылка на пользователя, который создал задание.
- `image_path` (String(255)) — путь к исходному изображению.
- `prompt` (Text) — текстовый запрос для обработки изображения.
- `status` (Enum(JobStatus), default=JobStatus.queued) — статус задания (queued, processing, completed, failed).
- `result_path` (String(255)) — путь к результату обработки (заполняется после завершения).
- `error` (Text) — сообщение об ошибке (если задание завершилось неудачно).
- `retry_count` (Integer, default=0) — количество попыток повторного выполнения задания.
- `created_at` (DateTime(timezone=True), server_default=func.now()) — дата и время создания задания.
- `updated_at` (DateTime(timezone=True), onupdate=func.now()) — дата и время последнего обновления статуса.

#### Назначение:
- Отслеживание всех заданий на обработку изображений
- Управление жизненным циклом заданий
- Хранение результатов и ошибок обработки
- Контроль количества попыток выполнения
- Связь заданий с пользователями

### 4. Таблица `payment_logs`

Хранит историю операций пополнения баланса (устаревшая таблица, используется для совместимости).

#### Поля:

- `id` (Integer, Primary Key, Index) — уникальный идентификатор записи лога.
- `user_id` (Integer, ForeignKey("users.user_id")) — ссылка на пользователя.
- `amount` (Float) — сумма операции.
- `status` (String(50), default="pending") — статус операции.
- `payment_id` (String(100)) — идентификатор платежа во внешней системе.
- `created_at` (DateTime(timezone=True), server_default=func.now()) — дата и время создания записи.

#### Назначение:
- История операций пополнения баланса
- Отслеживание статуса платежей
- Связь с пользователями

### 5. Таблица `payments`

Хранит информацию о платежах через систему оплаты (YuKassa).

#### Поля:

- `id` (Integer, Primary Key, Index) — уникальный идентификатор платежа.
- `user_id` (Integer, ForeignKey("users.user_id")) — ссылка на пользователя.
- `yukassa_payment_id` (String(100), Unique, Index) — идентификатор платежа в системе ЮKassa.
- `amount` (Integer) — сумма платежа в копейках (для точности расчетов).
- `currency` (String(3), default="RUB") — валюта платежа.
- `status` (Enum(PaymentStatus), default=PaymentStatus.pending) — статус платежа (pending, succeeded, failed, cancelled).
- `payment_type` (Enum(PaymentType), default=PaymentType.payment) — тип платежа (payment, weekly_bonus, refund).
- `payment_method` (String(50), default="card") — способ оплаты (карта, СБП и т.д.).
- `payment_method_details` (Text, nullable=True) — детали способа оплаты в формате JSON.
- `description` (Text, nullable=True) — описание платежа.
- `confirmation_url` (String(500), nullable=True) — URL для подтверждения платежа.
- `created_at` (DateTime(timezone=True), server_default=func.now()) — дата создания платежа.
- `updated_at` (DateTime(timezone=True), server_default=func.now(), onupdate=func.now()) — дата последнего обновления.
- `paid_at` (DateTime(timezone=True), nullable=True) — дата успешной оплаты.

#### Назначение:
- Хранение информации о платежах пользователей
- Интеграция с системой электронных платежей (ЮKassa)
- Отслеживание статуса платежей
- Учет различных способов оплаты
- Хранение истории бонусных начислений и возвратов

## Статусы и перечисления

### JobStatus
- `queued` — задание находится в очереди
- `processing` — задание в процессе выполнения
- `completed` — задание успешно выполнено
- `failed` — задание завершено с ошибкой

### PaymentStatus
- `pending` — ожидает оплаты
- `succeeded` — успешно оплачено
- `failed` — ошибка при оплате
- `cancelled` — отменено

### PaymentType
- `payment` — обычный платеж
- `weekly_bonus` — еженедельный бонус
- `refund` — возврат средств

## Связи между таблицами

- `jobs` связаны с `users` через поле `user_id`
- `payment_logs` связаны с `users` через поле `user_id`
- `payments` связаны с `users` через поле `user_id`

## Особенности реализации

1. **Поддержка миграций**: структура базы данных изменялась со временем, что отражено в файлах миграций. Последние изменения включают добавление поля `workflow_type` в пресеты и переименование поля `order` в `order_index`.

2. **Индексы**: созданы индексы для ускорения поиска по часто используемым полям (telegram_id, user_id, status и т.д.).

3. **Временные метки**: все таблицы содержат поля даты/времени для отслеживания событий.

4. **Поддержка разных способов оплаты**: система позволяет использовать разные методы оплаты (карты, СБП и др.) с хранением соответствующих деталей.

5. **Обработка ошибок**: предусмотрена возможность повторных попыток выполнения заданий и хранение информации об ошибках.

## Использование в приложении

Эта структура базы данных используется в следующих компонентах приложения:
- Backend API для управления данными
- Telegram-бот для взаимодействия с пользователями
- Worker-сервис для обработки заданий
- Система платежей для приема оплат