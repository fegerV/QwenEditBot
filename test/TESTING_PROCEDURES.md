# Тестирование QwenEditBot и ComfyUI

Данный документ описывает процедуры тестирования для QwenEditBot и интеграции с ComfyUI.

## Структура проекта

Проект состоит из трех основных компонентов:
1. **Backend** - FastAPI сервер с базой данных, интеграцией ComfyUI и системой оплаты
2. **Bot** - Telegram-бот на основе aiogram 3.x для взаимодействия с пользователями
3. **Worker** - Асинхронный воркер для обработки задач и взаимодействия с ComfyUI

## Тестирование ComfyUI

### Проверка подключения к ComfyUI

Для проверки подключения к ComfyUI используется скрипт `test_comfyui_connection.py`:

```bash
python test_comfyui_connection.py
```

Этот скрипт:
- Проверяет доступность ComfyUI по адресу, указанному в настройках
- Выполняет запрос к эндпоинту `/system_stats`
- Тестирует другие важные эндпоинты ComfyUI (`/object_info`, `/prompt`, `/queue`, `/history`)
- Показывает информацию о системе и доступной видеокарте

### Результаты теста

Тест покажет успешное подключение к ComfyUI, информацию о системе и состоянии, а также проверит доступность всех необходимых эндпоинтов.

## Тестирование Redis

Для проверки подключения к Redis используется скрипт `test_redis_connection.py`:

```bash
python test_redis_connection.py
```

Этот скрипт:
- Проверяет подключение к Redis как из backend, так и из worker
- Тестирует базовые операции чтения/записи
- Проверяет кросс-компонентную коммуникацию между backend и worker через Redis
- Тестирует функциональность очереди задач

## Тестирование API

Для проверки работоспособности API используется скрипт `test_api.py`:

```bash
python test_api.py
```

Этот скрипт:
- Создает тестовую базу данных
- Тестирует все основные эндпоинты API:
  - Регистрация пользователя
  - Получение информации о пользователе
  - Работа с балансом
  - Работа с пресетами
  - Создание и получение задач
- Проверяет корректность всех операций

## Тестирование функциональности бота

Для проверки функциональности бота используется скрипт `test_bot_functionality.py`:

```bash
python test_bot_functionality.py
```

Этот скрипт:
- Проверяет настройки конфигурации для всех компонентов
- Проверяет подключение к ComfyUI через воркер
- Проверяет подключение к backend API через бота
- Проверяет интеграцию между всеми компонентами

## Полная проверка системы

Для полной проверки всей системы можно запустить все тесты последовательно:

1. Проверьте, что ComfyUI запущен
2. Запустите backend:
   ```bash
   cd backend && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```
3. Запустите бота:
   ```bash
   python bot/run.py
   ```
4. Запустите воркер:
   ```bash
   python worker/run.py
   ```
5. Выполните тесты:
   ```bash
   python test_comfyui_connection.py
   python test_redis_connection.py
   python test_api.py
   python test_bot_functionality.py
   ```

## Ручное тестирование

Для ручного тестирования:

1. Зайдите в Telegram и найдите вашего бота
2. Используйте команду `/start`, чтобы начать взаимодействие
3. Проверьте все основные функции:
   - Регистрация нового пользователя
   - Проверка баланса
   - Загрузка изображений
   - Выбор пресетов
   - Отправка изображений на обработку
   - Получение результатов

## Проверка логов

Проверяйте логи каждого компонента для выявления возможных ошибок:

- Backend логи будут отображаться в терминале, где запущен backend
- Bot логи будут отображаться в терминале, где запущен бот
- Worker логи будут отображаться в терминале, где запущен воркер

## Диагностика проблем

Если возникают проблемы:

1. Проверьте, что все три компонента (backend, bot, worker) запущены
2. Проверьте настройки в `.env` файлах
3. Убедитесь, что ComfyUI доступен по указанному адресу
4. Проверьте сетевые соединения между компонентами
5. Изучите логи на наличие ошибок

## Заключение

Эти процедуры тестирования позволяют проверить корректность работы всей системы QwenEditBot и интеграции с ComfyUI. При успешном прохождении всех тестов система готова к использованию.