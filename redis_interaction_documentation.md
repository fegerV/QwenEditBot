# Взаимодействие воркера с Redis

## Общее описание

Воркер использует Redis для управления очередью заданий. Он добавляет новые задания в очередь, извлекает их для обработки и сохраняет результаты. Взаимодействие осуществляется с помощью асинхронного клиента `redis.asyncio`.

## Подключение к Redis

Воркер подключается к Redis с использованием следующих параметров:

- `host`: Адрес сервера Redis
- `port`: Порт сервера Redis
- `password`: Пароль для аутентификации (если требуется)
- `db`: Номер базы данных Redis
- `decode_responses`: Установлен в `False`, что означает, что ответы от Redis будут возвращаться в виде байтов

Подключение осуществляется с помощью класса `RedisQueueClient`, который предоставляет методы для взаимодействия с Redis.

## Формат данных

Все данные, передаваемые между воркером и Redis, сериализуются в формате JSON. Это позволяет легко передавать структурированные данные, такие как словари и списки.

### Формат задания

Задание представлено в виде словаря со следующими полями:

- `id`: Уникальный идентификатор задания
- `user_id`: Идентификатор пользователя, создавшего задание
- `image_path`: Путь к изображению, которое нужно обработать
- `prompt`: Текстовое описание, которое используется для генерации изображения
- `status`: Статус задания (например, 'queued', 'processing', 'completed')
- `created_at`: Время создания задания
- `updated_at`: Время последнего обновления задания

Пример JSON-представления задания:

```json
{
  "id": "12345",
  "user_id": 123,
  "image_path": "/path/to/image.jpg",
  "prompt": "A beautiful landscape",
  "status": "queued",
  "created_at": "2022-01-01T00:00:00Z",
  "updated_at": "2022-01-01T00:00:00Z"
}
```

## Операции с очередью

### Добавление задания в очередь

Для добавления задания в очередь используется метод `enqueue_job`. Он принимает словарь с данными задания и добавляет его в начало списка Redis с помощью команды `lpush`. Ключ очереди заданий определяется в настройках (`REDIS_JOB_QUEUE_KEY`).

Данные задания сериализуются в JSON перед добавлением в очередь.

### Извлечение задания из очереди

Для извлечения задания из очереди используется метод `dequeue_job`. Он использует команду `brpop`, которая блокирует операцию до тех пор, пока не появится новый элемент в очереди или не истечет время ожидания (в данном случае 1 секунда).

После извлечения данные десериализуются из JSON обратно в словарь Python.

### Получение ожидающих заданий

Для получения списка ожидающих заданий без удаления из очереди используется метод `get_pending_jobs`. Он использует команду `lrange`, чтобы получить указанное количество элементов из начала очереди.

## Обновление статуса задания

В текущей реализации обновление статуса задания в Redis не реализовано. Информация о статусе просто логируется, но не сохраняется в Redis.

## Сохранение результата задания

После завершения обработки задания его результат сохраняется в Redis с помощью метода `set_job_result`. Результат сохраняется с помощью команды `setex`, которая устанавливает TTL (время жизни) для ключа.

Ключ для результата задания формируется как `job_result:{job_id}`, где `{job_id}` — идентификатор задания.

Пример JSON-представления результата:

```json
{
  "job_id": 12345,
  "result_path": "/path/to/result.jpg",
  "completed_at": 1234567890.123
}
```

## Закрытие соединения

При завершении работы воркер закрывает соединение с Redis с помощью метода `close`, который вызывает соответствующий метод у асинхронного клиента Redis.

## Заключение

Взаимодействие воркера с Redis обеспечивает эффективное управление очередью заданий и позволяет масштабировать систему за счет распределения нагрузки между несколькими воркерами. Использование JSON для сериализации данных делает систему гибкой и удобной для обработки структурированных данных.