# Взаимодействие между сервисами: Бот, Бэкенд, Воркер, Redis, ComfyUI

## Общая архитектура

Система состоит из нескольких компонентов, которые работают вместе для обработки изображений с помощью AI:

1. **Telegram-бот** - предоставляет интерфейс для пользователей
2. **Бэкенд** - управляет данными, пользователями, балансом и очередями
3. **Воркер** - обрабатывает задания по редактированию изображений
4. **Redis** - обеспечивает очередь заданий между компонентами
5. **ComfyUI** - выполняет непосредственную обработку изображений с помощью AI

## Подробное описание взаимодействий

### 1. Telegram-бот

#### Основные функции:
- Прием изображений и команд от пользователей
- Взаимодействие с бэкендом через HTTP API
- Отображение результатов пользователям

#### Взаимодействие с другими компонентами:

**С бэкендом:**
- Регистрация новых пользователей через `/api/users/register`
- Получение списка пресетов через `/api/presets`
- Создание заданий на обработку изображений через `/api/jobs/create`
- Проверка баланса пользователя через `/api/users/by-telegram-id/{telegram_id}`
- Создание платежей через `/api/payments/create`

**С воркером:**
- Косвенное взаимодействие через Redis (бот не взаимодействует напрямую с воркером)

**С ComfyUI:**
- Нет прямого взаимодействия

**С Redis:**
- Нет прямого взаимодействия (через бэкенд)

### 2. Бэкенд

#### Основные функции:
- Управление базой данных (пользователи, задания, платежи)
- Обеспечение REST API для других компонентов
- Хранение и обновление статусов заданий
- Управление балансами пользователей

#### Взаимодействие с другими компонентами:

**С ботом:**
- Предоставляет API для регистрации пользователей, получения пресетов, создания заданий
- Обрабатывает вебхуки от Telegram через `/webhook`

**С воркером:**
- Предоставляет API для получения и обновления информации о заданиях
- Обрабатывает запросы от воркера для обновления статусов заданий

**С ComfyUI:**
- Нет прямого взаимодействия

**С Redis:**
- Добавляет новые задания в очередь через `redis_client.enqueue_job()`
- Обновляет статусы заданий в Redis

### 3. Воркер

#### Основные функции:
- Получение заданий из очереди Redis
- Обработка изображений с помощью ComfyUI
- Отправка результатов пользователям через Telegram
- Обработка ошибок и повторные попытки выполнения заданий

#### Взаимодействие с другими компонентами:

**С ботом:**
- Отправляет результаты обработки через Telegram API (косвенно, через Telegram)

**С бэкендом:**
- Получает информацию о заданиях через API
- Обновляет статусы заданий через API
- Запрашивает информацию о пользователях через API
- Выполняет возвраты средств через API

**С ComfyUI:**
- Отправляет рабочие процессы (workflows) через `/prompt`
- Проверяет статус выполнения через `/history/{prompt_id}`
- Загружает результаты через `/view`
- Проверяет здоровье системы через `/system_stats`

**С Redis:**
- Получает задания из очереди через `redis_client.dequeue_job()`
- Обновляет статусы заданий в Redis
- Сохраняет результаты заданий в Redis

### 4. Redis

#### Основные функции:
- Хранение очереди заданий для обработки
- Кэширование результатов выполнения заданий
- Обеспечение надежной передачи заданий между бэкендом и воркером

#### Взаимодействие с другими компонентами:

**С ботом:**
- Нет прямого взаимодействия

**С бэкендом:**
- Принимает новые задания от бэкенда
- Обеспечивает интерфейс для обновления статусов заданий

**С воркером:**
- Предоставляет задания воркеру из очереди
- Принимает обновления статусов заданий от воркера
- Хранит результаты выполнения заданий

**С ComfyUI:**
- Нет взаимодействия

### 5. ComfyUI

#### Основные функции:
- Выполнение непосредственной обработки изображений с помощью AI
- Запуск рабочих процессов (workflows) для редактирования изображений
- Генерация результатов обработки

#### Взаимодействие с другими компонентами:

**С ботом:**
- Нет прямого взаимодействия

**С бэкендом:**
- Нет прямого взаимодействия

**С воркером:**
- Принимает рабочие процессы от воркера
- Возвращает статус выполнения заданий
- Предоставляет доступ к результатам обработки

**С Redis:**
- Нет взаимодействия

## Процесс обработки изображения от начала до конца

1. **Пользователь отправляет изображение в Telegram-бота**
   - Бот получает обновление через вебхук от Telegram
   - Проверяет наличие пользователя в системе
   - Проверяет баланс пользователя
   - Сохраняет изображение в директорию ComfyUI input
   - Создает запись задания в базе данных
   - Добавляет задание в очередь Redis

2. **Бэкенд добавляет задание в очередь Redis**
   - Формирует JSON-объект с информацией о задании
   - Помещает задание в список (lpush) очереди Redis

3. **Воркер извлекает задание из очереди Redis**
   - Периодически опрашивает очередь Redis (brpop)
   - Получает информацию о задании

4. **Воркер обрабатывает задание**
   - Проверяет доступность GPU (через GPULock)
   - Проверяет здоровье ComfyUI
   - Обновляет статус задания на "processing"
   - Подготавливает рабочий процесс (workflow) для ComfyUI
   - Отправляет рабочий процесс в ComfyUI
   - Ожидает завершения обработки (опрос статуса)
   - Загружает результат из ComfyUI
   - Сохраняет результат в директорию вывода

5. **Воркер обновляет статус задания**
   - Обновляет статус в базе данных через бэкенд API
   - Сохраняет результат в Redis
   - Отправляет результат пользователю через Telegram

6. **Обработка ошибок**
   - Если задание завершается с ошибкой, проверяется количество попыток
   - Если количество попыток меньше максимального, задание возвращается в очередь
   - Если достигнут лимит попыток, задание помечается как "failed"

## Конфигурация взаимодействия

Каждый компонент имеет свои настройки для взаимодействия с другими:

- **Бот** использует `BACKEND_URL` для подключения к бэкенду
- **Бэкенд** использует настройки Redis для управления очередью
- **Воркер** использует:
  - `BACKEND_API_URL` для подключения к бэкенду
  - `REDIS_*` параметры для подключения к Redis
  - `COMFYUI_URL` для подключения к ComfyUI
  - `BOT_TOKEN` для отправки результатов пользователям

## Безопасность и надежность

- Использование очереди Redis обеспечивает надежную доставку заданий даже при сбоях
- Механизмы повторных попыток обеспечивают устойчивость к временным сбоям
- Проверка статуса ComfyUI перед обработкой заданий
- Использование блокировок GPU для предотвращения конфликта ресурсов
- Аутентификация через токены (Telegram Bot Token, Redis Password)